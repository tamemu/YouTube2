<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YouTubeプレイヤー（4×4対応）</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: sans-serif;
    }
    #topBar {
      width: 100%;
      background: #111;
      padding: 0.5px;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;
      text-align: right;
    }
    #showPopupBtn {
      position: absolute;
      top: 0%;
      right: 0%;
      width: 12vw;
      height: 4vw;
      min-width: 32px;
      min-height: 20px;
      font-size: 2vw;
      background: #222;
      color: white;
      border: 1px solid #555;
      cursor: pointer;
    }
    .popup {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9998;
    }
    .popup.active {
      display: block;
    }
    #popupControls {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      border: 1px solid #444;
      padding: 16px;
      z-index: 9999;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 10px #000;
    }
    #popupClose {
      background: red;
      color: white;
      border: none;
      cursor: pointer;
      position: absolute;
      top: 0.5vw;
      right: 0.5vw;
      font-size: 2vw;
    }
    #controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .control-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    select, input, button {
      font-size: 14px;
      padding: 6px;
      flex: 1;
    }
    #container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 10px;
      margin-top: 10px;
    }
    .video-thumb {
      position: relative;
      background: #222;
      border: 1px solid #444;
      padding-top: 56.25%;
    }
    .video-thumb iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="topBar">
    <button id="showPopupBtn">設定を開く</button>
  </div>

  <div id="popupOverlay" class="popup"></div>
  <div id="popupControls" class="popup">
    <button id="popupClose">×</button>
    <div id="controls">
      <div class="control-group">
        <select id="mainCategory" onchange="filterVideoList()">
          <option value="">大分類</option>
        </select>
        <select id="subCategory" onchange="filterVideoList()">
          <option value="">小分類</option>
        </select>
        <button onclick="clearFilters()">全解除</button>
      </div>
      <div class="control-group">
        <select id="videoList"></select>
        <button onclick="addSelectedVideo()">選択して追加</button>
        <select id="layoutSelect">
          <option value="1">1x1</option>
          <option value="2" selected>2x2</option>
          <option value="3">3x3</option>
          <option value="4">4x4</option>
        </select>
      </div>
      <div class="control-group">
        <input id="videoUrl" placeholder="YouTubeのURL">
        <button onclick="addVideoByUrl()">URL追加</button>
      </div>
    </div>
  </div>

  <div id="container"></div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    const container = document.getElementById("container");
    const layoutSelect = document.getElementById("layoutSelect");
    const videoList = document.getElementById("videoList");
    const mainCategory = document.getElementById("mainCategory");
    const subCategory = document.getElementById("subCategory");
    let videoData = [];

    function extractVideoID(url) {
      const match = url.match(/(?:v=|\/)([\w-]{11})(?:[&?]|$)/);
      return match ? match[1] : null;
    }

    function createVideo(id) {
      const div = document.createElement("div");
      div.className = "video-thumb";

      const iframe = document.createElement("iframe");
      iframe.src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen = true;

      div.appendChild(iframe);
      container.appendChild(div);
    }

    function addVideoByUrl() {
      const url = document.getElementById("videoUrl").value;
      const id = extractVideoID(url);
      if (!id) return alert("無効なURL");
      createVideo(id);
      document.getElementById("videoUrl").value = "";
    }

    function addSelectedVideo() {
      const url = videoList.value;
      const id = extractVideoID(url);
      if (!id) return alert("選択されたURLが無効です");
      createVideo(id);
    }

    layoutSelect.onchange = () => {
      const cols = layoutSelect.value;
      container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    };

    const togglePopup = show => {
      document.getElementById("popupOverlay").classList.toggle("active", show);
      document.getElementById("popupControls").classList.toggle("active", show);
    };

    document.getElementById("showPopupBtn").onclick = () => togglePopup(true);
    document.getElementById("popupClose").onclick = () => togglePopup(false);
    document.getElementById("popupOverlay").onclick = () => togglePopup(false);

    async function loadSpreadsheet() {
      const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTwHDe9XYtJGqxS_aEGJB7lDK-StQ4UKrrnxKALrPPmVL0aNrEyWwv1wilX-ohr1LQDYn5rvPb0EQll/pub?gid=1636424413&single=true&output=csv";
      const response = await fetch(sheetUrl);
      const csv = await response.text();
      const lines = csv.trim().split("\n").slice(1);
      videoData = lines.map(line => {
        const [title, main, sub, url] = line.split(",").map(x => x.replace(/"/g, "").trim());
        return { title, main, sub, url };
      }).filter(v => v.url);

      populateCategories();
      filterVideoList();
    }

    function populateCategories() {
      const mains = [...new Set(videoData.map(v => v.main))];
      const subs = [...new Set(videoData.map(v => v.sub))];

      mainCategory.innerHTML = '<option value="">大分類</option>' + mains.map(v => `<option>${v}</option>`).join("");
      subCategory.innerHTML = '<option value="">小分類</option>' + subs.map(v => `<option>${v}</option>`).join("");
    }

    function filterVideoList() {
      const main = mainCategory.value;
      const sub = subCategory.value;
      videoList.innerHTML = "";

      videoData.filter(v => (!main || v.main === main) && (!sub || v.sub === sub))
               .forEach(v => {
        const option = new Option(`${v.title} (${v.main}/${v.sub})`, v.url);
        videoList.add(option);
      });
    }

    function clearFilters() {
      mainCategory.value = "";
      subCategory.value = "";
      filterVideoList();
    }

    window.onload = () => {
      loadSpreadsheet();
    };
  </script>
</body>
</html>
